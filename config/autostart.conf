# ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
# ┃                    Autostart Configuration                  ┃
# ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

# All theme and environment variables are now set in environment.conf.
# Only use this file for autostart logic, session management, and exec-once commands.

#source = ~/.config/hypr/config/defaults.conf

# Autostart wiki https://wiki.hyprland.org/0.45.0/Configuring/Keywords/#executing #

# Launch tray-dependent apps after Waybar/UWSM tray is ready
exec-once = sleep 4 && uwsm app -- beeper &
# Note: ulauncher is managed by systemd (see systemctl --user enable ulauncher.service)
#exec-once = fcitx5 -d &
#exec-once = mako &
#exec-once = swaync
#exec-once = bash -c "mkfifo /tmp/$HYPRLAND_INSTANCE_SIGNATURE.wob && tail -f /tmp/$HYPRLAND_INSTANCE_SIGNATURE.wob | wob & disown" &

# Essential environment setup (replaces uwsm's environment handling)
exec-once = dbus-update-activation-environment --systemd WAYLAND_DISPLAY XDG_CURRENT_DESKTOP HYPRLAND_INSTANCE_SIGNATURE
exec-once = systemctl --user import-environment WAYLAND_DISPLAY XDG_CURRENT_DESKTOP HYPRLAND_INSTANCE_SIGNATURE

# Start GNOME keyring daemon
# exec-once = gnome-keyring-daemon --start --components=pkcs11,secrets,ssh

# Use GNOME polkit agent for better PAM integration with Howdy
# exec-once = /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1 &

# Export keyring variables to systemd
exec-once = systemctl --user import-environment GNOME_KEYRING_CONTROL SSH_AUTH_SOCK

# Cursor theme consistency setup
exec = gsettings set org.gnome.desktop.interface cursor-theme 'capitaine-cursors'
exec = gsettings set org.gnome.desktop.interface cursor-size 24
exec = hyprctl setcursor capitaine-cursors 24

# Initialize HyprQt6Engine for Qt6 application theming
exec-once = ~/.config/hypr/scripts/theme/init-hyprqt6engine.sh

exec-once = uwsm app -- pypr

# Dynamic gaps management for maximized windows
exec-once = ~/.config/hypr/scripts/dynamic-gaps.sh monitor &

# Waybar auto-hide handler for fullscreen mode
#exec-once = ~/.config/hypr/scripts/waybar-autohide.sh &

# Start pCloud
#exec-once = pcloud &

# ## Slow app launch fix
#exec-once = dbus-update-activation-environment --systemd --all
#exec-once = hash dbus-update-activation-environment 2>/dev/null
#exec-once = dbus-update-activation-environment --systemd DBUS_SESSION_BUS_ADDRESS DISPLAY WAYLAND_DISPLAY XDG_CURRENT_DESKTOP XDG_RUNTIME_DIR

# XDG Portal configuration for Hyprland
#exec-once = systemctl --user import-environment WAYLAND_DISPLAY XDG_CURRENT_DESKTOP DBUS_SESSION_BUS_ADDRESS
#exec-once = dbus-update-activation-environment --systemd WAYLAND_DISPLAY XDG_CURRENT_DESKTOP=Hyprland

#exec-once = /usr/lib/xdg-desktop-portal-hyprland &
#exec-once = sleep 2 && /usr/lib/xdg-desktop-portal &

# If you want screen sharing to work properly
#exec-once = systemctl --user start xdg-desktop-portal-hyprland

# Start 1Password (GNOME Keyring is started by systemd user service via D-Bus)
#exec-once = sleep 3 && /opt/1Password/1password --silent --use-system-authentication --on-system-unlock
# Start Mullvad VPN GUI with proper environment variables for Hyprland and GPU sandbox disabled
# NOTE: Mullvad is now started via XDG autostart desktop file with proper tray flags
#exec-once = XDG_CURRENT_DESKTOP=Hyprland WAYLAND_DISPLAY=wayland-1 "/opt/Mullvad VPN/mullvad-gui" --disable-gpu-sandbox --ozone-platform=wayland

# ## Idle configuration
exec-once = $idlehandler
# CopyQ is now started via XDG autostart desktop file with proper tray configuration
#exec-once = copyq &

# Process XDG autostart desktop files (replaces uwsm's autostart handling)
# exec-once = ~/.config/hypr/scripts/xdg-autostart.sh

# Bongo Cat overlay (positioned near Waybar date)
exec-once = uwsm app -- bongocat --watch-config --config ~/.config/bongocat.conf

# Quickshell instances
# Note: Tray apps must start BEFORE Quickshell for SystemTray.items to detect them
exec-once = uwsm app -- qs -c overview  # Workspace overview (Super+Tab)
#exec-once = sleep 2 && uwsm app -- qs -c waybar  # Neon cyberpunk bar (delay for tray apps)
# Signal readiness to systemd for UWSM
exec-once = uwsm finalize

# Apply dark theme settings
exec-once = ~/.config/hypr/scripts/theme/dark-theme-setup.sh

# Auto-restore session from previous logout
exec-once = bash -c '[ -f "$HOME/.config/hypr/saved-sessions/auto-logout.json" ] && (sleep 3 && SESSION_FILE="$HOME/.config/hypr/saved-sessions/auto-logout.json" ~/.config/hypr/scripts/restore-session.sh)'
#exec-once = uwsm app -- xsettingsd -c ~/.config/xsettingsd/xsettingsd.conf
